---
title: "Example: National Ambulatory Medical Care Survey (NAMCS) report"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Example-National-Ambulatory-Medical-Care-Survey-NAMCS-report}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This example uses the National Ambulatory Medical Care Survey (NAMCS) 2019 Public Use File (PUF) to replicate the estimates from a report called [Characteristics of Office-based Physician Visits by Age, 2019](https://www.cdc.gov/nchs/data/nhsr/nhsr184.pdf). NAMCS is "an annual nationally representative sample survey of visits to nonfederal office-based patient care physicians, excluding anesthesiologists, radiologists, and pathologists." Note that the unit of observation is visits, not patients â€“ this distinction is important since a single patient can make multiple visits. 

The survey is available in the `nchsdata` package. To make the below code more reusable, we'll call the survey by a generic name, namely, `mysurvey`. 

To calculate rates, we need another source of information with population estimates. You would typically use a function like `read.csv()` to load the population estimates and get them into the correct format. The `surveytable` package comes with an object called `uspop2019` that contains several population estimates. These will be used here to calculate rates.

# Begin

Begin by loading the `surveytable` package. When you do, it will print a message explaining how to specify the survey that you'd like to analyze. We are omitting that message here. 

```{r, results=FALSE, message=FALSE, warning=FALSE}
library(surveytable)
```

Now, specify the survey that you'd like to analyze.

```{r, results='asis'}
mysurvey = nchsdata::namcs2019
set_survey("mysurvey")
```

Check the survey name, survey design variables, and the number of observations to verify that it all looks correct.

# Figure 1 and Table 1

This figure and table show the rate of visits, overall, by age group, and by sex.

First, let's convert the numeric variable `AGE` into a categorical variable with the categories that are used in the figure. This is done using the `cut` function.

```{r}
mysurvey$variables$`Age group` = cut(mysurvey$variables$AGE
  , breaks = c(-Inf, 0, 17, 44, 64, Inf)
  , labels = c("Under 1", "1-17", "18-44", "45-64", "65 and over") )
```

Given the population estimates that are available in `uspop2019`, calculate the rates:

```{r, results='asis'}
total_rate(uspop2019$total)
tab_rate("Age group", uspop2019$`Age group`)
tab_rate("SEX", uspop2019$SEX)
```

# Figure 2 and Table 2

The figure shows the distribution of primary expected source of payment, and tests whether any of the pairs of percentages are equal. The table shows the same info by age group.

First, let's examine the levels of `PAYTYPER` (Type of payment). 

```{r}
levels(mysurvey$variables$PAYTYPER)
```

In the published figure, "Self-pay" and "No charge/Charity" have been combined into a category called "No insurance". Additionally, some categories are not shown in the published figure, which we will combine into a category called "etc". Let's combine the categories:

```{r}
mysurvey$variables$PAYTYPER = forcats::fct_collapse(mysurvey$variables$PAYTYPER
    , `No insurance` = c("Self-pay", "No charge/Charity")
    , etc = c("All sources of payment are blank", "Unknown"
      , "Worker's compensation", "Other"))
```

Now, tabulate this variable, testing equality of levels:

```{r, results='asis'}
tab("PAYTYPER", test = TRUE)
```

We can ignore results for the "etc" category, since it's not shown in the figure. Note that there are presentation flags for the "No insurance" category. The second table indicates that all differences are statistically significant. 

To replicate the table, we need a variable of age categories -- but these categories are different from the ones created above. Thus, create another age category variable, then tabulate subsets:

```{r, results='asis'}
mysurvey$variables$`Age group` = cut(mysurvey$variables$AGE
  , breaks = c(-Inf, 17, 64, Inf)
  , labels = c("Under 18", "18-64", "65 and over") )
tab_subset("PAYTYPER", "Age group")
```

Again, note the presentation flags. Some of the flags are concerned with counts -- since the published table does not show counts, we are not concerned with these. However, for the 18-64 age group, the "No insurance" category is flagged. 

# Figure 3 and Table 3

This figure shows the major reason for visit. While the data system has a variable called `MAJOR` (Major reason for this visit), that is not exactly the variable that is shown in the figure. Rather, the variable that is shown in the figure has been constructed from two variables: `MAJOR` and `INJURY` (Is visit related to an injury/trauma, ...). Specifically, if the visit is an injury visit (as indicated by `INJURY`), then the figure counts it as such. Otherwise, if it is not an injury visit, the figure counts it according to the value of `MAJOR`. In addition, the figure collapses some of the levels of `MAJOR`.

Let's begin by collapsing these levels of `MAJOR`, to match the figure:

```{r}
levels(mysurvey$variables$MAJOR)
mysurvey$variables$MAJOR = forcats::fct_collapse(mysurvey$variables$MAJOR
    , `Pre- and postsurgery` = c("Pre-surgery", "Post-surgery")
    , Chronic = c("Chronic problem, routine", "Chronic problem, flare-up"))
```

Create a new variable, called `Reason`. Initialize it to `NA`. Copy over all values of `MAJOR` to `Reason` other than "Blank" -- when `MAJOR` is "Blank", `Reason` becomes `NA`. Since we'll be combining two factor variables, an easy solution is to convert to character here, and then convert back to factor later. 

```{r}
idx = which( mysurvey$variables$MAJOR != "Blank" )
mysurvey$variables$Reason[idx] = as.character( mysurvey$variables$MAJOR[idx] )
```

Now, let's incorporate the `INJURY` variable. **Order matters!** We first added `MAJOR`, **then** `INJURY`. Since `INJURY` is added second, it trumps any value of `MAJOR`. This is what we want. 

```{r}
levels(mysurvey$variables$INJURY)
idx = which(mysurvey$variables$INJURY == "Yes")
mysurvey$variables$Reason[idx] = "Injury"

mysurvey$variables$Reason = as.factor(mysurvey$variables$Reason)
```

Since the figure is based on knowns only, use the `drop_na` argument to ignore missing values (`NA`):

```{r, results='asis'}
tab("Reason", drop_na = TRUE, test = TRUE)
```

The table shows the same information, by age group:

```{r, results='asis'}
tab_subset("Reason", "Age group", drop_na = TRUE)
```
