---
title: "Usage examples"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Usage examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Basics

## Setup

```{r setup}
library(prettysurvey)
set_survey("vars2019")
set_count_1k() # or set_count_int()
```

## Info about the survey

```{r}
show_survey()
```

```{r, results='asis'}
var_num()
var_list("age")
total()
```

## Tabulate

Tabulate a variable:

```{r, results='asis'}
tab("AGER")
```

Can tabulate multiple variables with a single command:

```{r, results='asis'}
tab("MDDO", "SPECCAT", "MSA")
```

## Tabulate subsets and interactions

```{r, results='asis'}
tab_subset("AGER", "SEX")
tab_cross("AGER", "SEX")
```

Create a variable that is an interaction of 2 other variables for later use:

```{r}
var_cross("Age x Sex", "AGER", "SEX")
```

Can use this variable later:

```{r, results='asis'}
tab("Age x Sex")
```

## Save the output

Either use the `out` argument, or the `prettysurvey.out.fname` option:

```{r, results='asis'}
total(out = "output.csv")
tab("AGER", out = "output.csv")
```

Or:

```{r, results='asis'}
options(prettysurvey.out.fname = "output.csv")
total()
tab("AGER")
options(prettysurvey.out.fname = "")
```

# Producing real-world tables

In this section, we reproduce certain tables from the [National Summary Tables](https://www.cdc.gov/nchs/data/ahcd/namcs_summary/2019-namcs-web-tables-508.pdf). Some estimates, especially the standard errors, are slightly different between the published tables and the output produced in these examples. The reason for this is that this report uses the NAMCS public use file, while the published tables were constructed using the NAMCS restricted file.

## Table 1
```{r, results='asis'}
total()
tab("MDDO", "SPECCAT", "MSA")
```

## Table 3
Use `cut` to recode a numeric variable into a categorical variable.

```{r, results='asis'}
vars2019$variables$`Another age recode` = cut(
	vars2019$variables$AGE
	, breaks = c(-Inf, 0, 4, 14, 64, Inf)
	, labels = c("Under 1", "1-4", "5-14", "15-64", "65 and over") )

tab("AGER", "Another age recode", "SEX")
tab_cross("AGER", "SEX")
```

## Table 5
Create new variables using Boolean functions.

```{r, results='asis'}
vars2019$variables = within(vars2019$variables, {
	`Medicare and Medicaid` = PAYMCARE & PAYMCAID
	`Unknown or blank` = PAYDK | (NOPAY == "No categories marked")
	bool.spp = !( PAYPRIV | PAYMCARE | PAYMCAID 
		| PAYWKCMP | PAYOTH | PAYDK)
	`Self-pay (real)` = PAYSELF & bool.spp
	`No charge (real)` = PAYNOCHG & bool.spp
	`No insurance` = `Self-pay (real)` | `No charge (real)`
})

tab("PAYPRIV", "PAYMCARE", "PAYMCAID", "Medicare and Medicaid"
	, "No insurance", "Self-pay (real)", "No charge (real)"
	, "PAYWKCMP", "PAYOTH", "Unknown or blank")
```

## Table 6
Combine multiple categories using `forcats::fct_collapse`.

```{r, results='asis'}
vars2019$variables = within(vars2019$variables, {
	PRIMCARE = forcats::fct_collapse(PRIMCARE, 
		`Unknown if PCP` = c("Unknown", "Blank"))
	REFER = forcats::fct_collapse(REFER, 
		`Unknown if referred` = c("Unknown", "Blank"))
})

tab("PRIMCARE", "REFER", "SENBEFOR")
tab_subset("PRIMCARE", "SENBEFOR")
tab_subset("REFER", "SENBEFOR")
```

## Table 11 (top half)

Use `var_cross` to create an interaction and save it for later use. Use the `for` loop to issue several similar commands. 

```{r, results='asis'}
var_cross("Age x Sex", "AGER", "SEX")

tab("MAJOR")

for (vr in c("AGER", "Another age recode", "SEX", "Age x Sex")) {
	tab_subset(vr, "MAJOR", "Preventive care")
}
```

For the following estimates, a more involved `for` loop is needed. Don't send the output to the screen; only send it to a CSV file.

```r
for (vr in c("AGER", "Another age recode", "SEX", "Age x Sex")) {
	cvr = paste0("MAJOR x ", vr)
	var_cross(cvr, "MAJOR", vr)
	for (lvl in levels(vars2019$variables[,vr])) {
		tab_subset("SPECCAT", cvr, paste0("Preventive care : ", lvl)
			, screen = FALSE, out = "out.csv")
	}
}
```
